DROP USER REGRA CASCADE;
CREATE USER REGRA IDENTIFIED BY REGRA ACCOUNT UNLOCK;
GRANT CONNECT,RESOURCE TO REGRA;

GRANT EXECUTE ON SYS.utl_file TO REGRA; -- CONNECT TO SYS / AS SYSDBA

CREATE OR REPLACE DIRECTORY "PL_DATA" AS 'C:\Java\Projetos\prolog\pl\'; -- CONNECT TO SYS / AS SYSDBA
CREATE OR REPLACE DIRECTORY "LOG_DATA" AS 'C:\Java\Projetos\prolog\log\'; -- CONNECT TO SYS / AS SYSDBA

GRANT READ,WRITE ON DIRECTORY PL_DATA TO REGRA; -- CONNECT TO SYS / AS SYSDBA
GRANT READ,WRITE ON DIRECTORY LOG_DATA TO REGRA; -- CONNECT TO SYS / AS SYSDBA


CREATE TABLE REGRA.CURSO(ID NUMBER NOT NULL, CURSO VARCHAR2(200) NOT NULL,
					CONSTRAINT PK_CURSO PRIMARY KEY (ID)
					,CONSTRAINT UK_CURSO UNIQUE  (CURSO));

CREATE TABLE REGRA.ALUNO(ID NUMBER NOT NULL, CPF NUMBER(11) NOT NULL,NOME VARCHAR2(100) NOT NULL, ANO_NASCIMENTO DATE, CURSO_ID NUMBER
				   ,CONSTRAINT PK_ALUNO PRIMARY KEY (ID)
				   ,CONSTRAINT UK_ALUNO_NOME UNIQUE  (CPF)
				   ,CONSTRAINT FK_ALUNO_CURSO FOREIGN KEY (CURSO_ID) REFERENCES REGRA.CURSO (ID));
				   
CREATE TABLE REGRA.VERBO(ID NUMBER NOT NULL, VERBO VARCHAR2(100) NOT NULL,
					CONSTRAINT PK_VERBO PRIMARY KEY (ID)
					,CONSTRAINT UK_VERBO UNIQUE  (VERBO));
					
CREATE TABLE REGRA.HABITO(ID NUMBER NOT NULL, HABITO VARCHAR2(200) NOT NULL,
					CONSTRAINT PK_HABITO PRIMARY KEY (ID)
					,CONSTRAINT UK_HABITO UNIQUE  (HABITO)
					);
					
CREATE TABLE REGRA.HABITO_VERBO(ID NUMBER NOT NULL, HABITO_ID NUMBER NOT NULL, VERBO_ID NUMBER NOT NULL,
					CONSTRAINT PK_HABITO_VERBO PRIMARY KEY (ID)
					,CONSTRAINT FK_HABITO_VERBO_V FOREIGN KEY (VERBO_ID) REFERENCES REGRA.VERBO (ID)
					,CONSTRAINT FK_HABITO_VERBO_H FOREIGN KEY (HABITO_ID) REFERENCES REGRA.HABITO (ID)
					);				  
					
CREATE TABLE REGRA.FATO(ID NUMBER NOT NULL, HABITO_VERBO_ID NUMBER NOT NULL, ALUNO_ID NUMBER NOT NULL,
				  CONSTRAINT PK_FATO PRIMARY KEY (ID),
				  CONSTRAINT UK_FATO UNIQUE (HABITO_VERBO_ID,ALUNO_ID),
				  CONSTRAINT FK_FATO_ALUNO FOREIGN KEY (ALUNO_ID) REFERENCES REGRA.ALUNO (ID),
				  CONSTRAINT FK_FATO_HABITO_VERBO FOREIGN KEY (HABITO_VERBO_ID) REFERENCES REGRA.HABITO_VERBO (ID)
				  );					

CREATE TABLE REGRA.REGRA(ID NUMBER NOT NULL, REGRA_PAI_ID NUMBER,CURSO_ID NUMBER NOT NULL, HABITO_VERBO_ID NUMBER NOT NULL,NEGA_HABITO CHAR(1) NOT NULL,
					CONSTRAINT PK_REGRA PRIMARY KEY (ID),
					--CONSTRAINT UK_REGRA UNIQUE (CURSO_ID,VERBO_ID,HABITO_ID),
					CONSTRAINT FK_REGRA_PAI FOREIGN KEY (REGRA_PAI_ID) REFERENCES REGRA.REGRA (ID),
					CONSTRAINT FK_REGRA_CURSO FOREIGN KEY (CURSO_ID) REFERENCES REGRA.CURSO (ID),
					CONSTRAINT FK_REGRA_HABITO_VERBO FOREIGN KEY (HABITO_VERBO_ID) REFERENCES REGRA.HABITO_VERBO (ID),
					CONSTRAINT CK_REGRA_NEGA_HABITO CHECK (NEGA_HABITO IN ('N','S'))
					);
					
set define off;
create or replace trigger regra.trg_update_id_pai before insert on regra.regra
 FOR EACH ROW
   
DECLARE
   v_username varchar2(10);
   
BEGIN
   -- Insert record into audit table
   if :new.REGRA_PAI_ID is null then
   :new.REGRA_PAI_ID := :new.ID;
   end if;
END;					
/

CREATE SEQUENCE REGRA.SEQ_REGRA_ID MINVALUE 56 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 56 NOCACHE  NOORDER  NOCYCLE ;
CREATE SEQUENCE REGRA.SEQ_CURSO_ID MINVALUE 9 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 9 NOCACHE  NOORDER  NOCYCLE ;
CREATE SEQUENCE REGRA.SEQ_FATO_ID MINVALUE 1 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  NOORDER  NOCYCLE ;
CREATE SEQUENCE REGRA.SEQ_HABITO_ID MINVALUE 56 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 56 NOCACHE  NOORDER  NOCYCLE ;
CREATE SEQUENCE REGRA.SEQ_ALUNO_ID MINVALUE 1 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  NOORDER  NOCYCLE ;
CREATE SEQUENCE REGRA.SEQ_VERBO_ID MINVALUE 16 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 16 NOCACHE  NOORDER  NOCYCLE ;
CREATE SEQUENCE REGRA.SEQ_HABITO_VERBO_ID MINVALUE 56 MAXVALUE 9999999999999 INCREMENT BY 1 START WITH 56 NOCACHE  NOORDER  NOCYCLE ;

--Insert Cursos
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (1,'Ciências Agrárias');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (2,'Artes e Desenho');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (3,'Ciências Biológicas e da Saúde');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (4,'Ciências  Exatas e Tecnologia / Engenharia');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (5,'Ciências Gerenciais e Administrativas');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (6,'Ciências Humanas');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (7,'Ciências Sociais Aplicadas');
INSERT INTO REGRA.CURSO  (ID, CURSO ) VALUES  (8,'Informação e Comunicação');
commit;

--Insert Verbos
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (1, 'gosta de');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (2, 'tem habilidade para');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (3, 'tem capacidade de');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (4, 'participa de');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (5, 'faz atividades de');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (6, 'faz uso de');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (7, 'leva jeito com');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (8, 'tem facilidade de');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (9, 'tem contato com');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (10, 'deseja');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (11, 'cria');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (12, 'tem interesse');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (13, 'tem conhecimento');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (14, 'ouve');
INSERT INTO REGRA.VERBO (ID, VERBO) VALUES (15, 'possui');
commit;


-- Habitos Ciências Agrárias
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (1, 'criar e cuidar de animais');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (2, 'Plantação de árvores frutíferas e produção de alimentos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (3, 'produção de alimentos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (4, 'trabalhar ao ar livre');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (5, 'estudar e observar organismos vivos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (6, 'observar, estudar e pensa na presevação da natureza');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (7, 'visitas a parques florestais');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (8, 'passeios ecológicos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (9, 'notícias de pesquisas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (10, 'em novas descobertas cientificas relacinadas à area biologicas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (11, 'em cuidar de problemas de saúde de animais');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (12, 'para plantar árvores frutíferas ou ornamentais');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (13, 'cultivar árvores frutíferas ou ornamentais');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (14, 'identificar tipos diferentes de plantas e árvores');

--Habitos Artes e Desenho
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (15, 'criação artística (desenho, pintura, escultura ou artesanato)');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (16, 'decorar um ambiente de forma criativa');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (17, 'representar peças de teatro');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (18, 'representar grupos musicais (voz, instrumento, composição ou arranjo)');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (19, 'produzir videos e filmagens');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (20, 'em produção de cartazes e peças de comunicação');

--Habitos Ciências Biológicas e da Saúde
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (21, 'em experimentos com pequenos animais em laboratório de biologia');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (22, 'alimentação saudável e equilibrada');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (23, 'estudar o comportamento da vida psíquica das pessoas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (24, 'em estudar as manifestações da vida psíquica das pessoas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (25, 'em cuidar da saúde física ou mental das pessoas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (26, 'esportes e exercícios físicos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (27, 'em identificar os nutrientes necessários a uma alimentação saudável e equilibrada');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (28, 'cuidar de problemas de saúde de pessoas');


--Hábitos/ Ciências Exatas e Tecnologia / Engenharia
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (29, 'cálculos númericos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (30, 'observar e estudar os fenômenos físicos e naturais');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (31, 'ler notícias sobre pesquisas e novas descobertas científicas relacionadas ao mundo físico');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (32, 'experimentos em laboratário de física ou de química');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (33, 'consertar aparelhos domesticos e outros');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (34, 'fazer uso de novas tecnologias');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (35, 'em descobrir os principios de funcionamento de máquinas e aparelhos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (36, 'em descobrir os princípios de funcionamento de programas e jogos de computador');

--Habitos Ciências Gerenciais e Administrativas
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (37, 'no uso de computador');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (38, 'organizar dados em tabelas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (39,'organizar dados em gráficos');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (40, 'realizar a análise de dados');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (41, 'administrar equipes');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (42, 'planejamento equipes');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (43, 'coordenar equipes');

-- Hábitos Ciências Humanas
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (44, 'línguas estrangeiras');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (45, 'leitura ou criação de textos literários (poesia, conto, crônica, romance ou ficção)');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (46, 'atividades relacionadas ao ensino e à educação de pessoas');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (47, 'notícias relacionadas a movimentos de grupos sociais que lutam por melhores condições de vida');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (48, 'pela história e cultura de outros povos');

--Hábitos Ciências Sociais Aplicadas
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (49, 'em Conversas ou notícias relacionadas a crimes, desrespeito às leis, práticas de corrupção e as medidas necessárias para sua punição');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (50, 'Organização de grupos de viagens e excursões');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (51, 'Elaboração de desenhos e esboços de projetos (objetos, móveis, escritório, sala, casa ou espaços abertos)');

--Hábitos Informação e Comunicação
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (52, 'Leitura de revistas e jornais de informação');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (53, 'programas de rádio e TV');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (54, 'Produção de cartazes e peças de comunicação');
INSERT INTO REGRA.HABITO (ID, HABITO) VALUES (55, 'Colaborar em jornais estudantis');
commit;

--inserir combinações
--AÇÕES - Habitos Ciências Agrárias
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (1,1,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (2,2,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (3,3,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (4,4,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (5,5,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (6,6,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (7,7,4);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (8,8,4);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (9,9,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (10,10,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (11,11,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (12,12,7);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES (13,13,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID) VALUES(14,14,8);


--AÇÕES - Habitos Artes e Desenho
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (15,15,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (16,16,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (17,17,8);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (18,18,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (19,19,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (20,20,12);



--AÇÕES - Habitos Ciências Biológicas e da Saúde
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (21,21,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (22,22,15);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (23,23,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (24,24,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (25,25,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (26,26,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (27,27,13);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (28,28,1);


--AÇÕES - Hábitos/ Ciências Exatas e Tecnologia / Engenharia
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (29,29,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (30,30,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (31,31,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (32,32,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (33,33,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (34,34,8);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (35,35,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (36,36,12);

--AÇÕES - Habitos Ciências Gerenciais e Administrativas
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (37,37,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (38,38,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (39,39,2);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (40,40,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (41,41,8);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (42,42,7);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (43,43,8);

--AÇÕES - Hábitos Ciências Humanas
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (44,44,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (45,45,4);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (46,46,4);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (47,47,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (48,48,12);


--AÇÕES - Hábitos Ciências Sociais Aplicadas
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (49,49,12);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (50,50,4);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (51,51,2);

--AÇÕES - Hábitos Informação e Comunicação
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (52,52,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (53,53,4);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (54,54,1);
INSERT INTO REGRA.HABITO_VERBO (ID,HABITO_ID,VERBO_ID )  VALUES (55,55,1);
commit;

commit;

commit;



--inserir combinações 'REGRA.REGRA'
--Ciências Agrárias
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (1,NULL,1,1,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (2,1,1,2,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (3,1,1,3,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (4,NULL,1,4,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (5,4,1,5,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (6,4,1,6,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (7,NULL,1,7,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (8,NULL,1,8,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (9,NULL,1,9,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (10,NULL,1,10,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (11,NULL,1,11,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (12,11,1,12,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (13,11,1,13,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (14,NULL,1,14,'N');


--Artes e Desenho
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (15,NULL,2,15,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (16,NULL,2,16,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (17,NULL,2,17,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (18,17,2,18,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (19,17,2,19,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (20,17,2,20,'N');

--Ciências Biológicas e da Saúde
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (21,NULL,3,21,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (22,NULL,3,22,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (23,22,3,23,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (24,22,3,24,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (25,22,3,25,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (26,NULL,3,26,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (27,NULL,3,27,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (28,27,3,28,'N');

--Hábitos/ Ciências Exatas e Tecnologia / Engenharia
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (29,NULL,4,29,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (30,NULL,4,30,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (31,NULL,4,31,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (32,31,4,32,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (33,31,4,33,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (34,31,4,34,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (35,NULL,4,35,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (36,NULL,4,36,'N');

--Habitos Ciências Gerenciais e Administrativas
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (37,NULL,5,37,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (38,NULL,5,38,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (39,NULL,5,39,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (40,39,5,40,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (41,39,5,41,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (42,39,5,42,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (43,NULL,5,43,'N');

--Hábitos Ciências Humanas
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (44,NULL,6,43,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (45,NULL,6,45,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (46,NULL,6,46,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (47,46,6,47,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (48,46,6,48,'N');

--Ciências Sociais Aplicadas
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (49,NULL,7,49,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (50,NULL,7,50,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (51,NULL,7,51,'N');

--Informação e Comunicação
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (52,NULL,8,52,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (53,NULL,8,53,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (54,NULL,8,54,'N');
INSERT INTO REGRA.REGRA  (ID,REGRA_PAI_ID,CURSO_ID,HABITO_VERBO_ID,NEGA_HABITO) VALUES (55,NULL,8,55,'N');

commit;

INSERT INTO REGRA.ALUNO  (    ID,    CPF,    NOME,    ANO_NASCIMENTO,    CURSO_ID  )
  VALUES   (REGRA.SEQ_ALUNO_ID.NEXTVAL, 01234568791, 'AFONSO', SYSDATE,  NULL);
  
INSERT INTO REGRA.ALUNO  (    ID,    CPF,    NOME,    ANO_NASCIMENTO,    CURSO_ID  )
  VALUES   (REGRA.SEQ_ALUNO_ID.NEXTVAL, 01234568792, 'ALUNO 3', SYSDATE,  NULL);
  
INSERT INTO REGRA.ALUNO  (    ID,    CPF,    NOME,    ANO_NASCIMENTO,    CURSO_ID  )
  VALUES   (REGRA.SEQ_ALUNO_ID.NEXTVAL, 01234568793, 'ALUNO 4', SYSDATE,  NULL);

commit;


INSERT INTO REGRA.FATO  (ID, HABITO_VERBO_ID, ALUNO_ID)  VALUES  (REGRA.SEQ_FATO_ID.NEXTVAL, 2,    2);
INSERT INTO REGRA.FATO  (ID, HABITO_VERBO_ID, ALUNO_ID)  VALUES  (REGRA.SEQ_FATO_ID.NEXTVAL, 3,    2);
INSERT INTO REGRA.FATO  (ID, HABITO_VERBO_ID, ALUNO_ID)  VALUES  (REGRA.SEQ_FATO_ID.NEXTVAL, 4,    3);
INSERT INTO REGRA.FATO  (ID, HABITO_VERBO_ID, ALUNO_ID)  VALUES  (REGRA.SEQ_FATO_ID.NEXTVAL, 5,    2);
                                                                                                    
INSERT INTO REGRA.FATO  (ID, HABITO_VERBO_ID, ALUNO_ID)  VALUES  (REGRA.SEQ_FATO_ID.NEXTVAL, 2,    3);
INSERT INTO REGRA.FATO  (ID, HABITO_VERBO_ID, ALUNO_ID)  VALUES  (REGRA.SEQ_FATO_ID.NEXTVAL, 3,    3);
commit;

set define off;
CREATE OR REPLACE 
	PACKAGE REGRA.REGRA_PKG AS
	
	name_file_pl	varchar2(200); -- variável para armazenar o nome do arquivo pl.
	name_log		varchar2(50); -- variável para armazenar o nome do log.
	
	-- procedure responsável por realizar a execução dos selects e criar o arquivo pl.
    PROCEDURE spu_generate_file_id (id_aluno IN NUMBER);
	
	-- procedure responsável por realizar a impressão das saídas para depuração. 
	PROCEDURE put_line (text IN VARCHAR2);
	
	-- procedure responsável por realizar a impressão das saídas para o arquivo pl.
	PROCEDURE print_line_pl (text IN VARCHAR2, id IN NUMBER);
	
	-- função responsável por gerar o nome do arquivo.
	FUNCTION get_name_file_pl (id_aluno IN NUMBER)
		RETURN VARCHAR2;
		
	PROCEDURE spu_boot_file_pl (id_aluno IN NUMBER);
	
	FUNCTION REMOVE_ACENTOS (pValue IN VARCHAR2)  RETURN  VARCHAR2;
	
	end REGRA_PKG;
/


create or replace
PACKAGE BODY REGRA.REGRA_PKG
IS

PROCEDURE spu_generate_file_id (id_aluno IN NUMBER)
IS
    v_fato			varchar(4000);
	v_fato_generico	varchar(4000);
    v_regra			varchar(4000);
	v_condicao		varchar(4000);
	c_fato			SYS_REFCURSOR;
	c_fato_generico	SYS_REFCURSOR;
	c_regra			SYS_REFCURSOR;
	
BEGIN
	spu_boot_file_pl (id_aluno);
	OPEN c_fato FOR (
	'SELECT REGRA.REGRA_PKG.REMOVE_ACENTOS(aux.HABITO) habito FROM (SELECT 
		LOWER( replace(replace(REGRA.VERBO.VERBO,'' '',''''),'','','''')) 
			|| ''(''||
		LOWER( replace(replace(REGRA.ALUNO.NOME,'' '',''''),'','',''''))
			||'',''||
		LOWER(replace(replace(REGRA.HABITO.HABITO,'' '',''''),'','',''''))
			||'').''
			as habito
		FROM REGRA.FATO
		INNER JOIN REGRA.HABITO_VERBO
		ON REGRA.HABITO_VERBO.ID = REGRA.FATO.HABITO_VERBO_ID
		INNER JOIN REGRA.VERBO
		ON REGRA.VERBO.ID = REGRA.HABITO_VERBO.VERBO_ID
		INNER JOIN REGRA.HABITO
		ON REGRA.HABITO.ID = REGRA.HABITO_VERBO.HABITO_ID
		INNER JOIN REGRA.ALUNO
		ON REGRA.ALUNO.ID = REGRA.FATO.ALUNO_ID
		where REGRA.FATO.ALUNO_ID ='||id_aluno||') aux'
	);
	
	LOOP
			/* lê um registro do cursor */
			FETCH c_fato INTO v_fato;
			/* abandona o loop caso seja o final do cursor */
			EXIT WHEN c_fato%NOTFOUND;
			
			print_line_pl(v_fato,id_aluno);
			
	END  LOOP;
	close c_fato;
	
	OPEN c_fato_generico FOR (
	'SELECT REGRA.REGRA_PKG.REMOVE_ACENTOS(aux.HABITO) habito FROM (SELECT 
		LOWER( replace(replace(REGRA.VERBO.VERBO,'' '',''''),'','','''')) 
			|| ''(''||
		LOWER( replace(replace(''alunoAleatorioX'','' '',''''),'','',''''))
			||'',''||
		LOWER(replace(replace(''habitoAleatorioY'','' '',''''),'','',''''))
			||'').''
			as habito
		FROM REGRA.VERBO order by REGRA.VERBO.VERBO) aux'
	);
	
	LOOP
			/* lê um registro do cursor */
			FETCH c_fato_generico INTO v_fato_generico;
			/* abandona o loop caso seja o final do cursor */
			EXIT WHEN c_fato_generico%NOTFOUND;
			
			print_line_pl(v_fato_generico,id_aluno);
			
	END  LOOP;
	close c_fato_generico;
	
	OPEN c_regra FOR ('
	SELECT REGRA.REGRA_PKG.REMOVE_ACENTOS(aux.curso) curso,REGRA.REGRA_PKG.REMOVE_ACENTOS(aux.regra) regra FROM (
		SELECT 
		  ''opcaoEscolhida(X,''|| (LOWER( replace(replace(REGRA.CURSO.CURSO||REGRA.CURSO.ID,'' '',''''),'','','''')) || '') :- '') as curso,
		  LISTAGG((LOWER( replace(replace(REGRA.VERBO.VERBO,'' '',''''),'','','''')) ||''(X,''|| LOWER( replace(replace(REGRA.HABITO.HABITO,'' '',''''),'','','''')) ||'')''), '', '') WITHIN GROUP (ORDER BY (''opcaoEscolhida(X,''|| (LOWER( replace(replace(REGRA.CURSO.CURSO||REGRA.CURSO.ID,'' '',''''),'','','''')) || '') :- ''))) ||''.'' as regra
		FROM REGRA.REGRA
		INNER JOIN REGRA.HABITO_VERBO
		ON REGRA.HABITO_VERBO.ID = REGRA.REGRA.HABITO_VERBO_ID
		INNER JOIN REGRA.VERBO
		ON REGRA.VERBO.ID = REGRA.HABITO_VERBO.VERBO_ID
		INNER JOIN REGRA.HABITO
		ON REGRA.HABITO.ID = REGRA.HABITO_VERBO.HABITO_ID
		INNER JOIN REGRA.CURSO
		ON REGRA.CURSO.ID = REGRA.REGRA.CURSO_ID
		group by regra.regra.regra_pai_id,(''opcaoEscolhida(X,''|| (LOWER( replace(replace(REGRA.CURSO.CURSO||REGRA.CURSO.ID,'' '',''''),'','','''')) || '') :- '')))aux');
		
	LOOP
			/* lê um registro do cursor */
			FETCH c_regra INTO v_regra,v_condicao;
			/* abandona o loop caso seja o final do cursor */
			EXIT WHEN c_regra%NOTFOUND;
			
			print_line_pl(v_regra||v_condicao,id_aluno);
			
	END  LOOP;
	close c_regra;
	
EXCEPTION
			-- caso haja uma exceção, mostra a exceção.
			WHEN others THEN
				put_line(' -- ');
				put_line('Erro spu_generate_file_id '||sqlerrm);
				put_line(' -- ');
END
	spu_generate_file_id;	
	

PROCEDURE spu_boot_file_pl (id_aluno IN NUMBER)
IS
	f  utl_file.file_type;
    file_name VARCHAR2(50);
BEGIN
	put_line(get_name_file_pl(id_aluno));
    file_name := get_name_file_pl(id_aluno);
    f := utl_file.fopen ('PL_DATA', file_name, 'W');
    utl_file.put_line ( f, '');
    utl_file.fclose (f);    
EXCEPTION
			-- caso haja uma exceção, mostra a exceção.
			WHEN others THEN
				put_line(' -- ');
				put_line('Erro spu_boot_file_pl '||sqlerrm);
				put_line(' -- ');
END
	spu_boot_file_pl;


FUNCTION get_name_file_pl (id_aluno IN NUMBER)
		RETURN VARCHAR2
		IS
			file_name VARCHAR2(50);		
		BEGIN
			name_file_pl  := 'A' || id_aluno;
			file_name := name_file_pl||'.pl';
			-- retorna a string concatenada
			RETURN file_name;
		EXCEPTION
			-- caso haja uma execeção, mostra a exceção e faz o rollback da transação 
			WHEN others THEN
				put_line('');
				put_line(sqlcode || ' '||sqlerrm);
				put_line('');
			ROLLBACK;
END
		get_name_file_pl;

-- procedure responsável por realizar a impressão das saídas para o arquivo pl. 
PROCEDURE print_line_pl (text IN VARCHAR2, id IN NUMBER)
IS
    f  utl_file.file_type;
    file_name VARCHAR2(50);
BEGIN
    file_name := get_name_file_pl(id);
    f := utl_file.fopen ('PL_DATA', file_name, 'A');
    utl_file.put_line ( f, text);
    utl_file.fclose (f);
    
    dbms_output.put_line(text);
	EXCEPTION
			-- caso haja uma exceção, mostra a exceção.
			WHEN others THEN
				put_line(' -- ');
				put_line('Erro print_line_pl '||sqlerrm);
				put_line(' -- ');
END
	print_line_pl;	


-- procedure resposável por gerar os logs da execução
PROCEDURE put_line (text IN VARCHAR2) 
IS
    f  utl_file.file_type;
    file_name VARCHAR2(50);
BEGIN
    file_name := name_log||'_' || to_char(trunc(SYSDATE),'ddmmyyyy') ||'.log';
    f := utl_file.fopen ('LOG_DATA', file_name, 'A');
    utl_file.put_line ( f, text);
    utl_file.fclose (f);
    dbms_output.put_line(text);
	EXCEPTION
			-- caso haja uma exceção, mostra a exceção.
			WHEN others THEN
				dbms_output.put_line('');
				dbms_output.put_line(sqlerrm);
				dbms_output.put_line('');
END
	put_line;
	
FUNCTION REMOVE_ACENTOS (pValue IN VARCHAR2)
  RETURN  VARCHAR2 IS
begin
      return translate(pValue,'ÑÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÄËÏÖÜÇñáéíóúàèìòùâêîôûãõäëïöüç/','NAEIOUAEIOUAEIOUAOAEIOUCnaeiouaeiouaeiouaoaeiouc');
    
END; -- Function REMOVE_ACENTO
	
end REGRA_PKG;
/	
